name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          # --- Set up SSH key ---
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write the key using printf to preserve exact content.
          # The trailing newline is critical for OpenSSH key parsing.
          printf '%s\n' "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Validate the key is parseable before attempting SSH
          ssh-keygen -l -f ~/.ssh/deploy_key

          # Pre-populate known_hosts to avoid MITM prompt
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          # --- Deploy ---
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" '
            set -e
            cd /home/ubuntu/barberbot
            git pull origin main
            ./venv/bin/pip install -q -r requirements.txt
            sudo systemctl restart barberbot
            echo "Deploy complete"
          '
